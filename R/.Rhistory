}
ggplot(data=com, aes(x0, y0))+ylim(c(-4.1,4.1))+xlim(c(-4.1,4.1))+
stat_chull(data=ci97.5, aes(x, y), geom="polygon", alpha=0.4)+
stat_chull(data=ci2.5, aes(x, y), geom="polygon", fill="white", alpha=1)+
geom_point()+
stat_chull(fill=NA, color="red", geom="polygon")+
theme(line=element_blank(),
panel.background=element_blank(),
axis.text=element_blank(),
title=element_blank())
}
fig1.1(com4, v160)
fig1.1(com4, v160)->p4
dev.off()
p4
p4+geom_point(data=com1, (x0,y0), color="blue")
p4+geom_point(data=com1, (x0,y0), color="blue"))
p4+geom_point(data=com1, aes(x0,y0), color="blue")
plot(com1)
p4+geom_point(data=com1, aes(x0,y0), color="blue")
p4+geom_point(data=com3, aes(x0,y0), color="blue")
dim(com4)
dim(com3)
plot(com4)
points(com1, col=2)
d1
3.54^2
4^2
3.54^3
4^3
plot(abs(com4)^2*sing(com4))
plot(abs(com4)^2*sign(com4))
plot(abs(com4)^3*sign(com4))
plot(abs(com4)^1.5*sign(com4))
plot(abs(com4)^5*sign(com4))
plot(com4*4)
plot(com4+4)^2)
plot((com4+4)^2)
plot((com4+4000000)^2)
plot((com4+4000000)^2)-4000000)
plot((com4+4000000)^2)-4000000))
plot(((com4+4000000)^2)-4000000)
range((com4+400000)^2)
range(com4)
diffrange((com4+400000)^2)
diff(range((com4+400000)^2)
)
diff(range((com2+400000)^2))
plot(((com4+4000000)^5)-4000000)
plot(com4)
plot(((com4+4000000)^5)-4000000)
points(((com2+4000000)^5)-4000000)
points(((com2+4000000)^5)-4000000, col=2)
quantile(v40, probs=c(.025, .975))
quantile(v80, probs=c(.025, .975))
quantile(v120, probs=c(.025, .975))
quantile(v160, probs=c(.025, .975))
37-24
42-32
43-37
diff(quantile(v160, probs=c(.025, .975)))
diff(quantile(v120, probs=c(.025, .975)))
diff(quantile(v80, probs=c(.025, .975)))
diff(quantile(v40, probs=c(.025, .975)))
median(quantile(v40, probs=c(.025, .975)))
median(quantile(v80, probs=c(.025, .975)))
median(quantile(v120, probs=c(.025, .975)))
median(quantile(v140, probs=c(.025, .975)))
median(quantile(v160, probs=c(.025, .975)))
p4
fig1.1(com1, v40)->p1
fig1.1(com2, v80)->p2
fig1.1(com3, v120)->p3
fig1.1(com4, v160)->p4
p3
p1
p2
p1
read.table("rs.tab4.fuzzy.txt")->rs.tab4
read.table("C:/Users/vincent/Desktop/rs.tab4.fuzzy.txt")->rs.tab4
library(pargwr)
SpatialPointsDataFrame(coords=rs.tab4[,c("X", "Y")], data=rs.tab4[,c("nbsp", "SESFRic_rxb", "nppt")])->sp.rs.tab
library(sp)
SpatialPointsDataFrame(coords=rs.tab4[,c("X", "Y")], data=rs.tab4[,c("nbsp", "SESFRic_rxb", "nppt")])->sp.rs.tab
gwr.sel.par(SESFRic_rxb~nppt, data=sp.rs.tab[2000,2999], tol=50000, beta1=0, beta2=600000, gweight=gwr.bisquare, longlat=F)
gwr.sel.par(SESFRic_rxb~nppt, data=sp.rs.tab[2000,2999], tol=50000, beta1=0, beta2=600000, gweight=gwr.bisquare, longlat=F)
gwr.sel.par(SESFRic_rxb~nppt, data=sp.rs.tab[c(2000:2999),], tol=50000, beta1=0, beta2=600000, gweight=gwr.bisquare, longlat=F)
gwr.sel.par(SESFRic_rxb~nppt, data=sp.rs.tab[c(2000:2999),], tol=50000, beta1=0, beta2=600000, gweight=gwr.Gauss, longlat=F)
gwr.bisquare
?gwr.bisquare
?gwr.Gauss
gwr.Gauss
(4/7)^2
16/7^2
16/(7^2)
source('~/.active-rstudio-document')
gwr.sel.par(SESFRic_rxb~nppt, data=sp.rs.tab, tol=50000, beta1=0, beta2=600000, gweight=gwr.Gauss, longlat=F)
dir("O:/ST_Ecoinformatics/C_Write/vincent/Postdoc_CIRCE/global_bird_hanpp/Results/packing.vs.expansion")
dir("O:/C_Write/vincent/Postdoc_CIRCE/global_bird_hanpp/Results/packing.vs.expansion")
load("O:/C_Write/vincent/Postdoc_CIRCE/global_bird_hanpp/Results/packing.vs.expansion/pack.list.fuzzyR3.B2.RData")
packs
load("O:/C_Write/vincent/Postdoc_CIRCE/global_bird_hanpp/Results/packing.vs.expansion/pack.list.5axes.RData")
pack.list[[22]]
pack.list[[21]]
pack.list[[23]]
pack.list[[23]]$RxB
unique(pack.list[[23]]$RxB)
unique(pack.list[[1]]$RxB)
unique(pack.list[[2]]$RxB)
sapply(pack.list, function(x) unique(x$RxB))
unlist(sapply(pack.list, function(x) unique(x$RxB)))
do.call(cbind(sapply(pack.list, function(x) unique(x$RxB))))
do.call(cbind, sapply(pack.list, function(x) unique(x$RxB)))
sapply(pack.list, function(x) as.character(unique(x$RxB)))
unlist(sapply(pack.list, function(x) as.character(unique(x$RxB))))
which(unlist(sapply(pack.list, function(x) as.character(unique(x$RxB))))=="R8.B6")
pack.list[[V8]]
pack.list[[8]]
load("C:/Users/vincent/Desktop/pack.exp.RData")
packing<-function(site.min, site.max, traits, mat) #here, site is the number/id of the cell
{
a.min<-mat[site.min,]
a.max<-mat[site.max,]
convhulln(traits[names(a.min[a.min>0]),1:5], "FA")$vol->vol.min
convhulln(traits[names(a.max[a.max>0]),1:5], "FA")$vol->vol.max
setdiff(names(a.max[a.max>0]), names(a.min[a.min>0]))->esp.unique.max
length(esp.unique.max)->nbsp.unique.max
intersect(names(a.max[a.max>0]), names(a.min[a.min>0]))->esp.comm
esp.rem<-NULL
volume.depaup<-rich.depaup<-vector()
for (i in seq(length(esp.unique.max)+length(esp.comm)))#length(esp.unique.max))
{
setdiff(esp.unique.max, esp.rem)->esp.unique.max
a.max.depaup<-as.data.frame(matrix(nrow=length(esp.unique.max), ncol=length(esp.unique.max), 1))
rownames(a.max.depaup)<-colnames(a.max.depaup)<-esp.unique.max
diag(a.max.depaup)<-0
a.max.depaup[,esp.comm]<-1
apply(a.max.depaup, 1, function(x) {convhulln(traits[names(x)[which(x>0)],1:5], options=c("FA", "QJ"))$vol})->fric.obs
names(which.max(vol.max-fric.obs))->esp.rem   #smallest difference
fric.obs[esp.rem]->volume.depaup[i]
sum(a.max.depaup[esp.rem,])->rich.depaup[i]
if(fric.obs[esp.rem]<=vol.min) break
}
return(list(pourc.pack=(1-((i-1)/sum(a.max)))*100, nb.esp.expansion=i-1, nb.esp.com=length(esp.comm),
nb.esp.min=sum(a.min), nb.esp.max=sum(a.max)))
}
getwd()
dir.create("C:/Users/vincent/Desktop/packing.vs.expansion")
pack.biomes<-function(m)
{
packs<-data.frame(matrix(ncol=20, nrow=0))
names(packs)<-c("RxB", "Sample", "NPP low", "NPP medium", "NPP high",
paste(c("pourc.pack", "nb.exp.expansion", "nb.esp.com", "nb.esp.min", "nb.esp.max"),
rep(c("lh", "mh", "lm"), each=5), sep="."))
for (i in seq(10))
{
rs.tab4[rs.tab4$realms_x_biomes==m,]->rs.tab.region
if(m=="R1.B2")
rs.tab.region<-rs.tab.region[rs.tab.region$nppt<400,]
rs.tab.region$cell<-as.character(rs.tab.region$cell)
cooc[is.element(rownames(cooc), rs.tab.region$cell),]->cooc_region
rs.tab.region$class.npp<-Hmisc::cut2(rs.tab.region$nppt, g=9)
rs.tab.region$class.npp<-cut(rs.tab.region$nppt, breaks=9, labels=F)
rs.tab.region$labels.class.npp<-cut(rs.tab.region$nppt, breaks=9)
if(length(unique(rs.tab.region$class.npp))!=9)
return(packs)
rs.tab.region.high<-rs.tab.region[rs.tab.region$class.npp==9,]
rs.tab.region.medium<-rs.tab.region[rs.tab.region$class.npp==5,]
rs.tab.region.low<-rs.tab.region[rs.tab.region$class.npp==1,]
rs.tab.region.high<-rs.tab.region.high[rs.tab.region.high$nbsp>max(rs.tab.region.high$nbsp)*.90,]    #high cell sampled in cells within 95% of max nbsp
cell.high.npp<-sample(rs.tab.region.high$cell,1)
nbsp.high.npp<-rs.tab.region.high$nbsp[rs.tab.region.high$cell==cell.high.npp]
cell.medium<-rs.tab.region.medium[which.min(abs(rs.tab.region.medium$nbsp-nbsp.high.npp/2)), "cell"] #cell closest to x% of the high npp cell
nbsp.medium<-rs.tab.region.medium[rs.tab.region.medium$cell==cell.medium, "nbsp"]
cell.medium.npp<-sample(rs.tab.region.medium[rs.tab.region.medium$nbsp>nbsp.medium*0.95 & rs.tab.region.medium$nbsp<nbsp.medium*1.05, "cell"],1)  #sampling one within all cells having ±5% species than the selected cell
nbsp.medium.npp<-rs.tab.region.medium[rs.tab.region.medium$cell==cell.medium.npp, "nbsp"]
rm(list=c("cell.medium", "nbsp.medium"))
cell.low<-rs.tab.region.low[which.min(abs(rs.tab.region.low$nbsp-nbsp.medium.npp/2)), "cell"] #cell closest to x% of the high npp cell
nbsp.low<-rs.tab.region.low[rs.tab.region.low$cell==cell.low, "nbsp"]
cell.low.npp<-sample(rs.tab.region.low[rs.tab.region.low$nbsp>nbsp.low*0.95 & rs.tab.region.low$nbsp<nbsp.low*1.05, "cell"],1)  #sampling one within all cells having ±5% species than the selected cell
nbsp.low.npp<-rs.tab.region.low[rs.tab.region.low$cell==cell.low.npp, "nbsp"]
rm(list=c("cell.low", "nbsp.low"))
packing(cell.low.npp, cell.high.npp, traits=traits, mat=cooc_region)->pack.LH
packing(cell.medium.npp, cell.high.npp, traits=traits, mat=cooc_region)->pack.MH
packing(cell.low.npp, cell.medium.npp, traits=traits, mat=cooc_region)->pack.LM
as.character(unique(rs.tab.region$labels.class.npp[rs.tab.region$class.npp==1]))->npp.l
as.character(unique(rs.tab.region$labels.class.npp[rs.tab.region$class.npp==4]))->npp.m
as.character(unique(rs.tab.region$labels.class.npp[rs.tab.region$class.npp==9]))->npp.h
data.frame(t(c(m, i, npp.l, npp.m, npp.h, unlist(pack.LH), unlist(pack.MH), unlist(pack.LM))))->pack.region
names(packs)->names(pack.region)
rbind(packs, pack.region)->packs
print(i)
}
print(paste(m, "Try n°", i))
# return(packs)
save(list="packs",
file=paste0("C:/Users/vincent/Desktop/packing.vs.expansion/pack.list.fuzzy", m,".RData"))
}
library(snowfall)
unique(rs.tab4$realms_x_biomes)->rxb
setdiff(rxb, c("R1.B2",  "R3.B12", "R3.B2",
"R3.B5",  "R3.B7",  "R3.B9",  "R4.B13",
"R5.B14", "R5.B2",  "R5.B7",  "R5.B8",
"R5.B9",  "R6.B7",  "R6.B9",  "R8.B1",
"R8.B2",  "R8.B7",  "R8.B8",  "R8.B9",
"R5.B1", "R8.B9"))->rxb
library(sp)
library(geometry)
setdiff(rxb, c("R1.B2",  "R3.B12", "R3.B2",
"R3.B5",  "R3.B7",  "R3.B9",  "R4.B13",
"R5.B14", "R5.B2",  "R5.B7",  "R5.B8",
"R5.B9",  "R6.B7",  "R6.B9",  "R8.B1",
"R8.B2",  "R8.B7",  "R8.B8",  "R8.B9",
"R5.B1", "R8.B9"))->rxb
sfInit(parallel=T, cpus=6)
sfExport(list=c("rs.tab4","pack.biomes", "packing", "cooc", "traits", "rxb"))
sfLibrary(geometry)
sfClusterApplyLB(rxb, function(x) pack.biomes(x))
sfStop()
getwd()
dir("C:/Users/vincent/Desktop/packing.vs.expansion")
dir("O:/C_Write/vincent/Postdoc_CIRCE/global_bird_hanpp/Results/packing.vs.expansion")
dir("O:/C_Write/vincent/Postdoc_CIRCE/global_bird_hanpp/Results/packing.vs.expansion")->aa
gsub("", "pack.list.fuzzy", aa)
aa
gsub("", "pack.list.fuzzy", aa, fixed=T)
?gsub
gsub("", "pack.list.fuzzy", aa, value=T)
gsub("pack.list.fuzzy", "", aa, value=T)
gsub("pack.list.fuzzy", "", aa)
gsub("pack.list.fuzzy", "", aa)->bb
gsub(".RData", "", bb)
gsub(""pack.list.5axes", "", cc)
gsub("pack.list.5axes", "", cc)
gsub(".RData", "", bb)->cc
gsub("pack.list.5axes", "", cc)
c("R1.B2", "R3.B12", "R3.B2", "R3.B5", "R3.B7", "R3.B9", "R4.B11", "R4.B13", "R4.B2", "R5.B1", "R5.B14",
"R5.B2", "R5.B7", "R5.B8", "R5.B9", "R6.B7", "R6.B9", "R8.B1", "R8.B13", "R8.B14" "R8.B2", "R8.B5", "R8.B6",
"R8.B7", "R8.B8", "R8.B9")
c("R1.B2", "R3.B12", "R3.B2", "R3.B5", "R3.B7", "R3.B9", "R4.B11", "R4.B13", "R4.B2", "R5.B1", "R5.B14",
"R5.B2", "R5.B7", "R5.B8", "R5.B9", "R6.B7", "R6.B9", "R8.B1", "R8.B13", "R8.B14", "R8.B2", "R8.B5", "R8.B6",
"R8.B7", "R8.B8", "R8.B9")
library(spgwr)
getwd()
setwd("~/pargwr/R")
document()
library(devtools)
document()
document()
install_github("vpellissier/pargwr")
library(pargwr)
?gwr.sel.par
?gwr.cv.f.par
?gwr.Gauss
?gwr
load("O:/C_Write/vincent/Postdoc_CIRCE/global_bird_hanpp/Results/packing.vs.expansion/pack.list.fuzzyR3.B13.RData")
ls()
packs
load("O:/C_Write/vincent/Postdoc_CIRCE/global_bird_hanpp/Results/packing.vs.expansion/pack.list.fuzzyR1.B6.RData")
packs
load("O:/C_Write/vincent/Postdoc_CIRCE/global_bird_hanpp/Results/packing.vs.expansion/pack.list.fuzzyR5.B7.RData")
packs
load("O:/C_Write/vincent/Postdoc_CIRCE/global_bird_hanpp/Results/packing.vs.expansion/pack.list.fuzzyR6.B9.RData")
packs
getwd()
dir("C/Users/vincent/Desktop/")
dir("C/Users/vincent/Desktop")
dir("C:/Users/vincent/Desktop")
load("C:/Users/vincent/Desktop/pack.exp.RData")
m<-"R6.B9"
packs<-data.frame(matrix(ncol=20, nrow=0))
names(packs)<-c("RxB", "Sample", "NPP low", "NPP medium", "NPP high",
paste(c("pourc.pack", "nb.exp.expansion", "nb.esp.com", "nb.esp.min", "nb.esp.max"),
rep(c("lh", "mh", "lm"), each=5), sep="."))
i<-1
rs.tab4[rs.tab4$realms_x_biomes==m,]->rs.tab.region
if(m=="R1.B2")
rs.tab.region<-rs.tab.region[rs.tab.region$nppt<400,]
rs.tab.region$cell<-as.character(rs.tab.region$cell)
cooc[is.element(rownames(cooc), rs.tab.region$cell),]->cooc_region
rs.tab.region$class.npp<-Hmisc::cut2(rs.tab.region$nppt, g=9)
rs.tab.region$class.npp<-cut(rs.tab.region$nppt, breaks=9, labels=F)
rs.tab.region$labels.class.npp<-cut(rs.tab.region$nppt, breaks=9)
if(length(unique(rs.tab.region$class.npp))!=9)
return(packs)
rs.tab.region.high<-rs.tab.region[rs.tab.region$class.npp==9,]
rs.tab.region.medium<-rs.tab.region[rs.tab.region$class.npp==5,]
rs.tab.region.low<-rs.tab.region[rs.tab.region$class.npp==1,]
rs.tab.region.high<-rs.tab.region.high[rs.tab.region.high$nbsp>max(rs.tab.region.high$nbsp)*.90,]    #high cell sampled in cells within 95% of max nbsp
cell.high.npp<-sample(rs.tab.region.high$cell,1)
nbsp.high.npp<-rs.tab.region.high$nbsp[rs.tab.region.high$cell==cell.high.npp]
cell.medium<-rs.tab.region.medium[which.min(abs(rs.tab.region.medium$nbsp-nbsp.high.npp/2)), "cell"] #cell closest to x% of the high npp cell
nbsp.medium<-rs.tab.region.medium[rs.tab.region.medium$cell==cell.medium, "nbsp"]
cell.medium.npp<-sample(rs.tab.region.medium[rs.tab.region.medium$nbsp>nbsp.medium*0.95 & rs.tab.region.medium$nbsp<nbsp.medium*1.05, "cell"],1)  #sampling one within all cells having ±5% species than the selected cell
nbsp.medium.npp<-rs.tab.region.medium[rs.tab.region.medium$cell==cell.medium.npp, "nbsp"]
rm(list=c("cell.medium", "nbsp.medium"))
cell.low<-rs.tab.region.low[which.min(abs(rs.tab.region.low$nbsp-nbsp.medium.npp/2)), "cell"] #cell closest to x% of the high npp cell
nbsp.low<-rs.tab.region.low[rs.tab.region.low$cell==cell.low, "nbsp"]
cell.low.npp<-sample(rs.tab.region.low[rs.tab.region.low$nbsp>nbsp.low*0.95 & rs.tab.region.low$nbsp<nbsp.low*1.05, "cell"],1)  #sampling one within all cells having ±5% species than the selected cell
nbsp.low.npp<-rs.tab.region.low[rs.tab.region.low$cell==cell.low.npp, "nbsp"]
rm(list=c("cell.low", "nbsp.low"))
system.time(packing(cell.low.npp, cell.high.npp, traits=traits, mat=cooc_region)->pack.LH)
library(geometry)
system.time(packing(cell.low.npp, cell.high.npp, traits=traits, mat=cooc_region)->pack.LH)
system.time(    packing(cell.low.npp, cell.high.npp, traits=traits, mat=cooc_region)->pack.LH
packing(cell.medium.npp, cell.high.npp, traits=traits, mat=cooc_region)->pack.MH
packing(cell.low.npp, cell.medium.npp, traits=traits, mat=cooc_region)->pack.LM)
system.time(packing(cell.low.npp, cell.high.npp, traits=traits, mat=cooc_region)->pack.LH
packing(cell.medium.npp, cell.high.npp, traits=traits, mat=cooc_region)->pack.MH
packing(cell.low.npp, cell.medium.npp, traits=traits, mat=cooc_region)->pack.LM)
system.time(    packing(cell.medium.npp, cell.high.npp, traits=traits, mat=cooc_region)->pack.MH
)
system.time(packing(cell.medium.npp, cell.high.npp, traits=traits, mat=cooc_region)->pack.MH
)
m<-"R3.B13"
packs<-data.frame(matrix(ncol=20, nrow=0))
names(packs)<-c("RxB", "Sample", "NPP low", "NPP medium", "NPP high",
paste(c("pourc.pack", "nb.exp.expansion", "nb.esp.com", "nb.esp.min", "nb.esp.max"),
rep(c("lh", "mh", "lm"), each=5), sep="."))
rs.tab4[rs.tab4$realms_x_biomes==m,]->rs.tab.region
if(m=="R1.B2")
rs.tab.region<-rs.tab.region[rs.tab.region$nppt<400,]
rs.tab.region$cell<-as.character(rs.tab.region$cell)
cooc[is.element(rownames(cooc), rs.tab.region$cell),]->cooc_region
rs.tab.region$class.npp<-Hmisc::cut2(rs.tab.region$nppt, g=9)
rs.tab.region$class.npp<-cut(rs.tab.region$nppt, breaks=9, labels=F)
rs.tab.region$labels.class.npp<-cut(rs.tab.region$nppt, breaks=9)
if(length(unique(rs.tab.region$class.npp))!=9)
return(packs)
rs.tab.region.high<-rs.tab.region[rs.tab.region$class.npp==9,]
rs.tab.region.medium<-rs.tab.region[rs.tab.region$class.npp==5,]
rs.tab.region.low<-rs.tab.region[rs.tab.region$class.npp==1,]
rs.tab.region.high<-rs.tab.region.high[rs.tab.region.high$nbsp>max(rs.tab.region.high$nbsp)*.90,]    #high cell sampled in cells within 95% of max nbsp
cell.high.npp<-sample(rs.tab.region.high$cell,1)
nbsp.high.npp<-rs.tab.region.high$nbsp[rs.tab.region.high$cell==cell.high.npp]
cell.medium<-rs.tab.region.medium[which.min(abs(rs.tab.region.medium$nbsp-nbsp.high.npp/2)), "cell"] #cell closest to x% of the high npp cell
nbsp.medium<-rs.tab.region.medium[rs.tab.region.medium$cell==cell.medium, "nbsp"]
cell.medium.npp<-sample(rs.tab.region.medium[rs.tab.region.medium$nbsp>nbsp.medium*0.95 & rs.tab.region.medium$nbsp<nbsp.medium*1.05, "cell"],1)  #sampling one within all cells having ±5% species than the selected cell
nbsp.medium.npp<-rs.tab.region.medium[rs.tab.region.medium$cell==cell.medium.npp, "nbsp"]
rm(list=c("cell.medium", "nbsp.medium"))
cell.low<-rs.tab.region.low[which.min(abs(rs.tab.region.low$nbsp-nbsp.medium.npp/2)), "cell"] #cell closest to x% of the high npp cell
nbsp.low<-rs.tab.region.low[rs.tab.region.low$cell==cell.low, "nbsp"]
cell.low.npp<-sample(rs.tab.region.low[rs.tab.region.low$nbsp>nbsp.low*0.95 & rs.tab.region.low$nbsp<nbsp.low*1.05, "cell"],1)  #sampling one within all cells having ±5% species than the selected cell
nbsp.low.npp<-rs.tab.region.low[rs.tab.region.low$cell==cell.low.npp, "nbsp"]
rm(list=c("cell.low", "nbsp.low"))
system.time(    packing(cell.low.npp, cell.high.npp, traits=traits, mat=cooc_region)->pack.LH
)
packing<-function(site.min, site.max, traits, mat) #here, site is the number/id of the cell
{
a.min<-mat[site.min,]
a.max<-mat[site.max,]
convhulln(traits[names(a.min[a.min>0]),1:5], "FA")$vol->vol.min
convhulln(traits[names(a.max[a.max>0]),1:5], "FA")$vol->vol.max
setdiff(names(a.max[a.max>0]), names(a.min[a.min>0]))->esp.unique.max
length(esp.unique.max)->nbsp.unique.max
intersect(names(a.max[a.max>0]), names(a.min[a.min>0]))->esp.comm
esp.rem<-NULL
volume.depaup<-rich.depaup<-vector()
for (i in seq(length(esp.unique.max)+length(esp.comm)))#length(esp.unique.max))
{
setdiff(esp.unique.max, esp.rem)->esp.unique.max
a.max.depaup<-as.data.frame(matrix(nrow=length(esp.unique.max), ncol=length(esp.unique.max), 1))
rownames(a.max.depaup)<-colnames(a.max.depaup)<-esp.unique.max
diag(a.max.depaup)<-0
a.max.depaup[,esp.comm]<-1
apply(a.max.depaup, 1, function(x) {convhulln(traits[names(x)[which(x>0)],1:5], options=c("FA", "QJ"))$vol})->fric.obs
names(which.max(vol.max-fric.obs))->esp.rem   #smallest difference
fric.obs[esp.rem]->volume.depaup[i]
sum(a.max.depaup[esp.rem,])->rich.depaup[i]
print(i)
if(fric.obs[esp.rem]<=vol.min) break
}
return(list(pourc.pack=(1-((i-1)/sum(a.max)))*100, nb.esp.expansion=i-1, nb.esp.com=length(esp.comm),
nb.esp.min=sum(a.min), nb.esp.max=sum(a.max)))
}
packs<-data.frame(matrix(ncol=20, nrow=0))
names(packs)<-c("RxB", "Sample", "NPP low", "NPP medium", "NPP high",
paste(c("pourc.pack", "nb.exp.expansion", "nb.esp.com", "nb.esp.min", "nb.esp.max"),
rep(c("lh", "mh", "lm"), each=5), sep="."))
rs.tab4[rs.tab4$realms_x_biomes==m,]->rs.tab.region
if(m=="R1.B2")
rs.tab.region<-rs.tab.region[rs.tab.region$nppt<400,]
rs.tab.region$cell<-as.character(rs.tab.region$cell)
cooc[is.element(rownames(cooc), rs.tab.region$cell),]->cooc_region
rs.tab.region$class.npp<-Hmisc::cut2(rs.tab.region$nppt, g=9)
rs.tab.region$class.npp<-cut(rs.tab.region$nppt, breaks=9, labels=F)
rs.tab.region$labels.class.npp<-cut(rs.tab.region$nppt, breaks=9)
if(length(unique(rs.tab.region$class.npp))!=9)
return(packs)
rs.tab.region.high<-rs.tab.region[rs.tab.region$class.npp==9,]
rs.tab.region.medium<-rs.tab.region[rs.tab.region$class.npp==5,]
rs.tab.region.low<-rs.tab.region[rs.tab.region$class.npp==1,]
rs.tab.region.high<-rs.tab.region.high[rs.tab.region.high$nbsp>max(rs.tab.region.high$nbsp)*.90,]    #high cell sampled in cells within 95% of max nbsp
cell.high.npp<-sample(rs.tab.region.high$cell,1)
nbsp.high.npp<-rs.tab.region.high$nbsp[rs.tab.region.high$cell==cell.high.npp]
cell.medium<-rs.tab.region.medium[which.min(abs(rs.tab.region.medium$nbsp-nbsp.high.npp/2)), "cell"] #cell closest to x% of the high npp cell
nbsp.medium<-rs.tab.region.medium[rs.tab.region.medium$cell==cell.medium, "nbsp"]
cell.medium.npp<-sample(rs.tab.region.medium[rs.tab.region.medium$nbsp>nbsp.medium*0.95 & rs.tab.region.medium$nbsp<nbsp.medium*1.05, "cell"],1)  #sampling one within all cells having ±5% species than the selected cell
nbsp.medium.npp<-rs.tab.region.medium[rs.tab.region.medium$cell==cell.medium.npp, "nbsp"]
rm(list=c("cell.medium", "nbsp.medium"))
cell.low<-rs.tab.region.low[which.min(abs(rs.tab.region.low$nbsp-nbsp.medium.npp/2)), "cell"] #cell closest to x% of the high npp cell
nbsp.low<-rs.tab.region.low[rs.tab.region.low$cell==cell.low, "nbsp"]
cell.low.npp<-sample(rs.tab.region.low[rs.tab.region.low$nbsp>nbsp.low*0.95 & rs.tab.region.low$nbsp<nbsp.low*1.05, "cell"],1)  #sampling one within all cells having ±5% species than the selected cell
nbsp.low.npp<-rs.tab.region.low[rs.tab.region.low$cell==cell.low.npp, "nbsp"]
rm(list=c("cell.low", "nbsp.low"))
)system.time(packing(cell.low.npp, cell.high.npp, traits=traits, mat=cooc_region)->pack.LH)
system.time(packing(cell.low.npp, cell.high.npp, traits=traits, mat=cooc_region)->pack.LH)
cell.high.npp
sum(cooc_region[○cell.high.npp,])
sum(cooc_region[cell.high.npp,])
sum(cooc_region[cell.low.npp,])
cell.low.npp->site.min
cell.high.npp->site.max
mat<-cooc_region
a.min<-mat[site.min,]
a.max<-mat[site.max,]
convhulln(traits[names(a.min[a.min>0]),1:5], "FA")$vol->vol.min
convhulln(traits[names(a.max[a.max>0]),1:5], "FA")$vol->vol.max
setdiff(names(a.max[a.max>0]), names(a.min[a.min>0]))->esp.unique.max
length(esp.unique.max)->nbsp.unique.max
intersect(names(a.max[a.max>0]), names(a.min[a.min>0]))->esp.comm
esp.rem<-NULL
volume.depaup<-rich.depaup<-vector()
seq(length(esp.unique.max)+length(esp.comm))
length(esp.unique.max)
i<-2
setdiff(esp.unique.max, esp.rem)->esp.unique.max
a.max.depaup<-as.data.frame(matrix(nrow=length(esp.unique.max), ncol=length(esp.unique.max), 1))
rownames(a.max.depaup)<-colnames(a.max.depaup)<-esp.unique.max
diag(a.max.depaup)<-0
a.max.depaup[,esp.comm]<-1
apply(a.max.depaup, 1, function(x) {convhulln(traits[names(x)[which(x>0)],1:5], options=c("FA", "QJ"))$vol})->fric.obs
library(snowfall)
?sfInit
sfInit(parallel=T, cpus=4)
sfExport("traits")
sfLibrary(geometry)
setdiff(esp.unique.max, esp.rem)->esp.unique.max
a.max.depaup<-as.data.frame(matrix(nrow=length(esp.unique.max), ncol=length(esp.unique.max), 1))
rownames(a.max.depaup)<-colnames(a.max.depaup)<-esp.unique.max
diag(a.max.depaup)<-0
a.max.depaup[,esp.comm]<-1
t1<-sys.time()
sfExport("a.max.depaup")
sfApply(a.max.depaup, 1, function(x) {convhulln(traits[names(x)[which(x>0)],1:5], options=c("FA", "QJ"))$vol})->fric.obs
system.time()
Sys.time()
sfStop()
sfInit(parallel=T, cpus=4)
sfExport("traits")
sfLibrary(geometry)
t1<-Sys.time()
sfExport("a.max.depaup")
sfApply(a.max.depaup, 1, function(x) {convhulln(traits[names(x)[which(x>0)],1:5], options=c("FA", "QJ"))$vol})->fric.obs
sfStop()
t2<-Sys.time()
t2t-1
t2-t1
t3<-Sys.time()
apply(a.max.depaup, 1, function(x) {convhulln(traits[names(x)[which(x>0)],1:5], options=c("FA", "QJ"))$vol})->fric.obs
t4<-Sys.time()
t4-t3
packing.par<-function(site.min, site.max, traits, mat) #here, site is the number/id of the cell
{
a.min<-mat[site.min,]
a.max<-mat[site.max,]
convhulln(traits[names(a.min[a.min>0]),1:5], "FA")$vol->vol.min
convhulln(traits[names(a.max[a.max>0]),1:5], "FA")$vol->vol.max
setdiff(names(a.max[a.max>0]), names(a.min[a.min>0]))->esp.unique.max
length(esp.unique.max)->nbsp.unique.max
intersect(names(a.max[a.max>0]), names(a.min[a.min>0]))->esp.comm
esp.rem<-NULL
sfInit(parallel=T, cpus=4)
sfExport("traits")
sfLibrary(geometry)
volume.depaup<-rich.depaup<-vector()
for (i in seq(length(esp.unique.max)+length(esp.comm)))#length(esp.unique.max))
{
setdiff(esp.unique.max, esp.rem)->esp.unique.max
a.max.depaup<-as.data.frame(matrix(nrow=length(esp.unique.max), ncol=length(esp.unique.max), 1))
rownames(a.max.depaup)<-colnames(a.max.depaup)<-esp.unique.max
diag(a.max.depaup)<-0
a.max.depaup[,esp.comm]<-1
sfExport("a.max.depaup")
sfApply(a.max.depaup, 1, function(x) {convhulln(traits[names(x)[which(x>0)],1:5], options=c("FA", "QJ"))$vol})->fric.obs
# t3<-Sys.time()
# apply(a.max.depaup, 1, function(x) {convhulln(traits[names(x)[which(x>0)],1:5], options=c("FA", "QJ"))$vol})->fric.obs
# t4<-Sys.time()
names(which.max(vol.max-fric.obs))->esp.rem   #smallest difference
fric.obs[esp.rem]->volume.depaup[i]
sum(a.max.depaup[esp.rem,])->rich.depaup[i]
print(i)
if(fric.obs[esp.rem]<=vol.min) break
}
sfStop()
return(list(pourc.pack=(1-((i-1)/sum(a.max)))*100, nb.esp.expansion=i-1, nb.esp.com=length(esp.comm),
nb.esp.min=sum(a.min), nb.esp.max=sum(a.max)))
}
sfStop()
syste.time(packing(cell.low.npp, cell.high.npp, traits=traits, mat=cooc_region)->pack.LH)
system.time(packing(cell.low.npp, cell.high.npp, traits=traits, mat=cooc_region)->pack.LH)
system.time(packing.par(cell.low.npp, cell.high.npp, traits=traits, mat=cooc_region)->pack.LH2)
151/68
setdiff(esp.unique.max, esp.rem)->esp.unique.max
a.max.depaup<-as.data.frame(matrix(nrow=length(esp.unique.max), ncol=length(esp.unique.max), 1))
rownames(a.max.depaup)<-colnames(a.max.depaup)<-esp.unique.max
diag(a.max.depaup)<-0
a.max.depaup[,esp.comm]<-1
a.max.depaup
a.max.depaup[♠1/5,1/5]
a.max.depaup[1:5;1:5]
a.max.depaup[1:5,1:5]
